import{A as l,r as u,u as S,z,j as s,h as M}from"./index-CZSZZV6j.js";import{W as D}from"./watchHistory-BPNt32Ju.js";class N{static DANGEROUS_KEYS=["__proto__","constructor","prototype","valueOf","toString","hasOwnProperty","isPrototypeOf","propertyIsEnumerable"];static MAX_DEPTH=10;static MAX_STRING_LENGTH=1e4;static safeParse(e,t){try{if(typeof e!="string")return l.warn("Invalid JSON input type:",typeof e),t;if(e.length>this.MAX_STRING_LENGTH)return l.warn("JSON string too long, potential DoS attack"),t;const r=JSON.parse(e);return this.isValidObject(r)?this.sanitizeObject(r,0):(l.warn("Invalid or dangerous JSON structure detected"),t)}catch(r){return l.warn("JSON parsing failed:",r),t}}static isValidObject(e){if(e==null||typeof e!="object")return!0;if(this.hasDangerousKeys(e))return!1;try{JSON.stringify(e)}catch{return l.warn("Circular reference detected in JSON"),!1}return!0}static hasDangerousKeys(e){if(typeof e!="object"||e===null)return!1;for(const t of Object.keys(e)){if(this.DANGEROUS_KEYS.includes(t))return l.warn("Dangerous key detected:",t),!0;if(typeof e[t]=="object"&&e[t]!==null&&this.hasDangerousKeys(e[t]))return!0}return!1}static sanitizeObject(e,t){if(t>this.MAX_DEPTH)return l.warn("Maximum object depth exceeded"),null;if(e==null||typeof e!="object")return e;if(Array.isArray(e))return e.map(i=>this.sanitizeObject(i,t+1));const r={};for(const[i,y]of Object.entries(e)){if(this.DANGEROUS_KEYS.includes(i)){l.warn("Skipping dangerous key:",i);continue}const d=this.sanitizeKey(i);d&&(r[d]=this.sanitizeObject(y,t+1))}return r}static sanitizeKey(e){return typeof e!="string"?null:e.replace(/[<>'"&\x00-\x1f\x7f-\x9f]/g,"").substring(0,100)}static parsePostMessageData(e){return typeof e=="string"?this.safeParse(e,null):typeof e=="object"&&e!==null?this.sanitizeObject(e,0):null}static validatePlayerMessage(e){if(!e||typeof e!="object")return!1;const t=["PLAYER_EVENT","VIDEO_END","FULLSCREEN","PLAY","PAUSE"],r=["play","pause","ended","fullscreen","exitfullscreen"];return e.type&&!t.includes(e.type)?(l.warn("Invalid message type:",e.type),!1):e.event&&!r.includes(e.event)?(l.warn("Invalid event type:",e.event),!1):!0}}const _=({source:o,onClose:e,isOpen:t,mediaItem:r,mediaType:i,season:y,episode:d,onNextEpisode:x})=>{if(!o||!t)return null;const[k,w]=u.useState(!0),f=u.useRef(void 0),p=u.useRef(null),{deviceInfo:g,isMobile:O}=S(),m=g.os==="ios"&&O,E=()=>{w(!0),f.current&&clearTimeout(f.current),f.current=window.setTimeout(()=>{w(!1)},3e3)};return u.useEffect(()=>{if(!t||o.type!=="embed")return;const n=c=>{try{if(!["https://www.vidking.net","https://vidking.net"].includes(c.origin)){console.warn("ðŸš« Blocked message from unauthorized origin:",c.origin);return}const v=N.parsePostMessageData(c.data);if(!v||!N.validatePlayerMessage(v)){console.warn("ðŸš« Invalid or dangerous message structure");return}if(v.type==="PLAYER_EVENT"){const{data:a}=v;console.log("VidKing Player Event:",a),a.event==="play"?console.log("ðŸŽ¬ VidKing player started playing"):a.event==="pause"&&console.log("â¸ï¸ VidKing player paused"),a.event==="fullscreen"&&console.log("ðŸ” VidKing fullscreen event detected:",a),r&&a.event==="timeupdate"&&a.currentTime>30&&D.updateWatchHistory(r,Math.floor(a.currentTime),Math.floor(a.duration),i||"movie",y,d),a.event==="ended"&&i==="tv"&&x&&console.log("Episode ended, VidKing will handle next episode automatically")}}catch{}},h=window.open;window.open=function(c){return console.log("ðŸš« Blocked popup/redirect attempt to:",c),null};const b=c=>(c.preventDefault(),c.returnValue="",console.log("ðŸš« Blocked navigation attempt"),"");return window.addEventListener("message",n),window.addEventListener("beforeunload",b),()=>{window.removeEventListener("message",n),window.removeEventListener("beforeunload",b),window.open=h}},[t,o.type,r,i,y,d,x]),u.useEffect(()=>{if(t){const n=setTimeout(()=>{w(!1)},3e3);return()=>clearTimeout(n)}},[t]),u.useEffect(()=>()=>{f.current&&clearTimeout(f.current)},[]),z.createPortal(s.jsx("div",{className:"fixed inset-0 z-[9999] bg-black",children:s.jsx("div",{className:"relative w-full h-full flex flex-col",onMouseMove:E,onTouchStart:E,children:s.jsxs("div",{className:"flex-1 relative",style:{backgroundColor:"#000",overflow:"hidden"},children:[s.jsx("iframe",{ref:p,src:`${o.url}${o.url.includes("?")?"&":"?"}autoplay=1&muted=1&playsinline=1`,className:"w-full h-full border-0",allowFullScreen:!0,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen *; fullscreen 'self' *; autoplay *",sandbox:"allow-scripts allow-same-origin allow-forms allow-presentation allow-popups-to-escape-sandbox",referrerPolicy:"no-referrer",loading:"eager",title:`${o.provider} Player`,webkitallowfullscreen:"true",mozallowfullscreen:"true",autoPlay:m?"true":void 0,playsInline:m?"true":void 0,style:{border:"none",outline:"none",width:"100%",height:"100%",backgroundColor:"#000",zIndex:1,position:"relative"},onLoad:()=>{if(console.log("ðŸŽ¬ Player loaded"),console.log("ðŸ“± Device:",{isIPhone:m,deviceInfo:g}),m&&p.current){console.log("ðŸ“± iPhone detected - attempting autoplay");try{const n=new URL(o.url).origin;p.current.contentWindow?.postMessage({command:"play",action:"play",type:"play"},n),setTimeout(()=>{const h=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});p.current?.dispatchEvent(h)},500)}catch(n){console.log("Could not trigger autoplay:",n)}}try{const n=p.current;n&&n.contentWindow&&(n.contentWindow.open=function(){return console.log("ðŸš« Blocked popup attempt"),null})}catch{console.log("Could not access iframe content (CORS protection active)")}}}),s.jsxs("div",{className:`absolute inset-0 transition-opacity duration-300 ${k?"opacity-100":"opacity-0"}`,style:{pointerEvents:"none",zIndex:10},children:[s.jsx("div",{className:"absolute top-0 left-0 right-0 h-20 bg-gradient-to-b from-black/50 to-transparent"}),s.jsxs("div",{className:"absolute top-0 left-0 right-0 p-4 flex items-center justify-between",style:{paddingTop:g.os==="ios"?"calc(1rem + env(safe-area-inset-top))":"1rem",paddingLeft:g.os==="ios"?"calc(1rem + env(safe-area-inset-left))":"1rem",paddingRight:g.os==="ios"?"calc(1rem + env(safe-area-inset-right))":"1rem"},children:[s.jsxs("button",{onClick:e,className:"flex items-center space-x-2 px-4 py-2 bg-black/70 hover:bg-black/90 rounded-lg transition-colors backdrop-blur-sm z-50 touch:active:scale-95",style:{pointerEvents:"auto"},children:[s.jsx(M,{className:"w-5 h-5"}),s.jsx("span",{className:"text-sm",children:"Back"})]}),s.jsx("div",{className:"flex items-center space-x-2",style:{pointerEvents:"none"},children:s.jsxs("span",{className:"text-sm bg-black/50 px-2 py-1 rounded backdrop-blur-sm",children:[o.provider," â€¢ ",o.quality]})})]})]})]})})}),document.body)};export{_ as default};
